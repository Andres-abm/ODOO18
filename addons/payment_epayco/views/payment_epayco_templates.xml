<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <template id="redirect_form">
        <form t-att-action="api_url" method="post">
            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
            <input type="hidden" name="public_key" t-att-value="public_key"/>
            <input type="hidden" name="private_key" t-att-value="private_key"/>
            <input type="hidden" name="amount" t-att-value="amount"/>
            <input type="hidden" name="tax" t-att-value="tax"/>
            <input type="hidden" name="base_tax" t-att-value="base_tax"/>
            <input type="hidden" name="currency" t-att-value="currency"/>
            <input type="hidden" name="email" t-att-value="email"/>
            <input type="hidden" name="firstname" t-att-value="firstname"/>
            <input type="hidden" name="reference" t-att-value="reference"/>
            <input type="hidden" name="lang_checkout" t-att-value="lang_checkout"/>
            <input type="hidden" name="checkout_external" t-att-value="checkout_external"/>
            <input type="hidden" name="test" t-att-value="test"/>
            <input type="hidden" name="notify_url" t-att-value="confirmation_url"/>
            <input type="hidden" name="return_url" t-att-value="response_url"/>
            <input type="hidden" name="extra2" t-att-value="extra2"/>
            <input type="hidden" name="ip" t-att-value="ip"/>
            <input type="hidden" name="total" t-att-value="total"/>
            <input type="hidden" name="language" t-att-value="language"/>
            <input type="hidden" name="PM" t-att-value="PM"/>
            <input type="hidden" name="url" t-att-value="url"/>
            <input type="hidden" name="cellphone" t-att-value="cellphone"/>
            <input type="hidden" name="country" t-att-value="country"/>
            <input type="hidden" name="city" t-att-value="city"/>
            <input type="hidden" name="zip" t-att-value="zip"/>
            <input type="hidden" name="address" t-att-value="address"/>
        </form>
    </template>
    <template id="proccess">
     <xpath expr="head" position="inside">
        <link rel="stylesheet" href="/payment_epayco/static/src/css/styles.css" type="text/css"/>
     </xpath>
      <t t-call="website.layout">
        <br />
        <div id="wrap">
                <div class="oe_structure oe_empty">
                    <div class="container" style="text-align: center;">
                        <div class="loader-container">
                            <div class="loading"></div>
                        </div>
                        <p style="text-align: center;" class="epayco-title">
                            <span class="animated-points" id="loading-payments">Cargando...</span>
                            <br/>
                            <small class="epayco-subtitle"></small>
                        </p>
                         <center>
                            <a id="btn_epayco" href="#">
                                <img src="https://multimedia.epayco.co/epayco-landing/btns/Boton-epayco-color1.png" style="border-width:0px;" />
                            </a>
                         </center>
                        <div id="form-button-container">
                            <form>
                                <input type="hidden" name="epayco_token" t-att-value="epayco_token"/>
                                <input type="hidden" name="amount" t-att-value="amount"/>
                                <input type="hidden" name="tax" t-att-value="tax"/>
                                <input type="hidden" name="base_tax" t-att-value="base_tax"/>
                                <input type="hidden" name="currency" t-att-value="currency"/>
                                <input type="hidden" name="email" t-att-value="email"/>
                                <input type="hidden" name="firstname" t-att-value="firstname"/>
                                <input type="hidden" name="reference" t-att-value="reference"/>
                                <input type="hidden" name="lang_checkout" t-att-value="lang_checkout"/>
                                <input type="hidden" name="checkout_external" t-att-value="checkout_external"/>
                                <input type="hidden" name="test" t-att-value="test"/>
                                <input type="hidden" name="notify_url" t-att-value="notify_url"/>
                                <input type="hidden" name="return_url" t-att-value="return_url"/>
                                <input type="hidden" name="extra2" t-att-value="extra2"/>
                                <input type="hidden" name="address" t-att-value="address"/>
                                <input type="hidden" name="ip" t-att-value="ip"/>
                                <script src="https://checkout.epayco.co/checkout-v2.js"></script>
                                <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
                                    <script type="text/javascript">
                                        (async function () {
                                            let epayco_token = document.getElementsByName("epayco_token")[0].value;
                                            let amount = document.getElementsByName("amount")[0].value;
                                            let tax = document.getElementsByName("tax")[0].value;
                                            let base_tax = document.getElementsByName("base_tax")[0].value;
                                            let currency = document.getElementsByName("currency")[0].value;
                                            let email = document.getElementsByName("email")[0].value;
                                            let firstname = document.getElementsByName("firstname")[0].value;
                                            let reference = document.getElementsByName("reference")[0].value;
                                            let lang = document.getElementsByName("lang_checkout")[0].value;
                                            let checkout_external = document.getElementsByName("checkout_external")[0].value;
                                            let test = document.getElementsByName("test")[0].value;
                                            let notify_url = document.getElementsByName("notify_url")[0].value;
                                            let return_url = document.getElementsByName("return_url")[0].value;
                                            let extra2 = document.getElementsByName("extra2")[0].value;
                                            let address = document.getElementsByName("address")[0].value;
                                            let ip = await _getIp();
                                            let extras_epayco = {"extra5": "P32"};
                                            var checkout_lang = lang == "es_CO" ? "es" : "en";
                                            if(lang=="es"){
                                                document.getElementById("loading-payments").innerText='Cargando...'
                                            }else{
                                                document.getElementById("loading-payments").innerText='Loading...'
                                            }
                                            var data = {
                                                checkout_version: "2",
                                                name: reference.substring(0, 50),
                                                description: reference.substring(0, 50),
                                                invoice: reference,
                                                currency: currency.toLowerCase(),
                                                amount: parseFloat(amount),
                                                taxBase: parseFloat(base_tax),
                                                tax: parseFloat(tax),
                                                taxIco: parseFloat(0),
                                                country: "CO",
                                                lang: lang,
                                                confirmation: notify_url,
                                                response: return_url,
                                                billing: {
                                                    name: firstname,
                                                    address: address,
                                                    email: email,
                                                },
                                                autoclick: true,
                                                ip: ip,
                                                test: test.toString() === "true",
                                                extras: {
                                                    extra2: extra2,
                                                    extra3: reference
                                                },
                                                extrasEpayco: {
                                                    extra5: "P32"
                                                },
                                                method: "POST",
                                                autoClick: false,
                                                methodsDisable: [],
                                                autoClick: false,
                                                dues: 1,
                                                noRedirectOnClose: true,
                                                forceResponse: false,
                                                uniqueTransactionPerBill: false,
                                                config: {},
                                             
                                            };

                                            var openCheckout = function () {
                                                var btnPagar = document.getElementById("btn_epayco");
                                                if (btnPagar) {
                                                    btnPagar.classList.add("disabled");
                                                }
                                                if (localStorage.getItem("invoicePayment") == null) {
                                                    localStorage.setItem("invoicePayment", data.invoice);
                                                    makePayment(epayco_token, data, data.external == "true");
                                                } else {
                                                    if (localStorage.getItem("invoicePayment") != data.invoice) {
                                                        localStorage.removeItem("invoicePayment");
                                                        localStorage.setItem("invoicePayment", data.invoice);
                                                        makePayment(epayco_token, data, data.external == "true");
                                                    } else {
                                                        makePayment(epayco_token, data, data.external == "true");
                                                    }
                                                }
                                            };
                                            var makePayment = async function (token_epayco, info, external) {
                                                const headers = { "Content-Type": "application/json" };
                                                if (token_epayco) {
                                                    headers["Authorization"] = `Bearer ${token_epayco}`;
                                                }
                                                try {
                                                    const response = await fetch("https://apify.epayco.co/payment/session/create", {
                                                        method: "POST",
                                                        body: JSON.stringify(info),
                                                        headers,
                                                    });
                                                    
                                                    if (!response.ok) {
                                                        throw new Error(`HTTP error! status: ${response.status}`);
                                                    }
                                                    const session = await response.json();
                                                    if (session.success &amp;&amp; session.data &amp;&amp; session.data.sessionId) {
                                                        const sessionId = session.data.sessionId;
                                                        localStorage.removeItem("sessionPayment");
                                                        localStorage.setItem("sessionPayment", sessionId);
                                                        // Verificar que ePayco checkout esté disponible
                                                        if (!window.ePayco || !window.ePayco.checkout) {
                                                            throw new Error("ePayco checkout library not loaded");
                                                        }
                                                       
                                                        const checkout = window.ePayco.checkout.configure({
                                                            sessionId: sessionId,
                                                            type: external ? "standard" : "onepage",
                                                            test: info.test
                                                        });
    
                                                        // Event handlers
                                                        checkout.onCreated(() => {
                                                            console.log("Evento cuando se crea el flujo transaccional");
                                                        });

                                                        checkout.onErrors(errors => {
                                                            console.log("Evento que notifica un error en la integración");
                                                            console.error(errors);
                                                        });

                                                        checkout.onClosed(() => {
                                                            console.log("Evento que notifica cuando se cierra el checkout");
                                                            var btnPagar = document.getElementById("btn_epayco");
                                                            if (btnPagar) {
                                                                btnPagar.classList.remove("disabled");
                                                            }
                                                        });
                                                        
                                                        if (checkout &amp;&amp; typeof checkout.open === 'function') {
                                                            checkout.open();
                                                        } else {
                                                            console.error("Error: checkout.open no está disponible");
                                                            console.log("checkout object:", checkout);
                                                        }
                                                    } else {
                                                        console.error("Error: Respuesta inválida del servidor o sessionId no encontrado.", session);
                                                        alert("Error al inicializar el checkout. Por favor, inténtelo de nuevo.");
                                                    }
                                                } catch (error) {
                                                    console.error("Error al procesar el pago:", error);
                                                    alert("Error al procesar el pago: " + error.message);
                                                } finally {
                                                    var btnPagar = document.getElementById("btn_epayco");
                                                    if (btnPagar) {
                                                        btnPagar.classList.remove("disabled");
                                                    }
                                                }
                                            };

                                            async function _getIp() {
                                                try {
                                                    const response = await fetch("https://api.ipify.org?format=json");
                                                    const result = await response.json();
                                                    return result.ip;
                                                } catch (error) {
                                                    console.error("Error al obtener la IP:", error);
                                                }
                                            }

                                            var btnPagar = document.getElementById("btn_epayco");
                                            if (btnPagar) {
                                                btnPagar.addEventListener("click", openCheckout);
                                            }
                                            openCheckout();
                                            window.onload = function () {
                                                document.addEventListener("contextmenu", function (e) {
                                                    e.preventDefault();
                                                }, false);
                                            };
                                        })();
                                    </script>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
           <br />
      </t>
    </template>

</odoo>
